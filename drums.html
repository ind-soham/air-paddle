<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Drums: Fixed</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap" rel="stylesheet">
    
    <style>
        body { margin: 0; background: #050505; overflow: hidden; font-family: 'Orbitron', sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; color: white; }
        
        #game-wrapper { position: relative; width: 100%; max-width: 900px; aspect-ratio: 16/9; border: 2px solid #ff00ff; border-radius: 12px; overflow: hidden; background: #000; }
        
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: scaleX(-1); }

        /* OVERLAY SCREEN */
        #overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            z-index: 50;
        }

        h1 { font-size: 3rem; margin-bottom: 10px; background: linear-gradient(90deg, #ff00ff, #00ffff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* The Big Button */
        #init-btn {
            background: transparent;
            color: #00ffff;
            border: 3px solid #00ffff;
            padding: 20px 50px;
            font-size: 1.5rem;
            font-family: 'Orbitron', sans-serif;
            cursor: pointer;
            margin-top: 20px;
            transition: 0.2s;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
        }
        #init-btn:hover { background: #00ffff; color: black; box-shadow: 0 0 40px #00ffff; }

        #status-log { margin-top: 20px; color: #666; font-size: 0.9rem; font-family: monospace; }
        
        .back-btn { position: absolute; top: 20px; left: 20px; z-index: 60; color: white; text-decoration: none; font-size: 1.2rem; opacity: 0.7; }
    </style>
</head>
<body>

<div id="game-wrapper">
    <a href="index.html" class="back-btn">‚Üê MENU</a>
    
    <div id="overlay">
        <h1>NEON DRUMS</h1>
        <p>Air Drumming Simulator</p>
        <button id="init-btn">CLICK TO START</button>
        <div id="status-log">Waiting for user input...</div>
    </div>

    <video id="input_video" style="display:none" playsinline></video>
    <canvas id="output_canvas"></canvas>
</div>

<script>
    const overlay = document.getElementById('overlay');
    const initBtn = document.getElementById('init-btn');
    const statusLog = document.getElementById('status-log');
    const canvas = document.getElementById('output_canvas');
    const ctx = canvas.getContext('2d');
    const video = document.getElementById('input_video');

    let audioCtx;
    let isRunning = false;

    // --- AUDIO SYSTEM (Synthesizer) ---
    function initAudio() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
    }

    function playSound(freq, type) {
        if (!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        
        if (type === 'kick') {
            osc.frequency.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            gain.gain.setValueAtTime(1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
        } else if (type === 'snare') {
            osc.type = 'triangle';
            gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
        } else { // Hi-hat
            osc.type = 'square';
            osc.frequency.setValueAtTime(800, audioCtx.currentTime); 
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);
        }

        osc.start(audioCtx.currentTime);
        osc.stop(audioCtx.currentTime + 0.5);
    }

    // --- GAME LOGIC ---
    const drums = [
        { name: "KICK", x: 0.5, y: 0.7, r: 0.15, color: "#ff00ff", freq: 150, type: 'kick', cd: 0 },
        { name: "SNARE", x: 0.2, y: 0.4, r: 0.12, color: "#00ffff", freq: 250, type: 'snare', cd: 0 },
        { name: "HI-HAT", x: 0.8, y: 0.4, r: 0.12, color: "#00ff00", freq: 800, type: 'hat', cd: 0 }
    ];

    function onResults(results) {
        // Hide overlay once first frame is processed
        if (!isRunning) {
            isRunning = true;
            overlay.style.display = 'none';
        }

        const w = canvas.width;
        const h = canvas.height;

        ctx.save();
        ctx.clearRect(0, 0, w, h);
        
        // Darken Camera
        ctx.filter = 'grayscale(100%) brightness(40%)';
        ctx.drawImage(results.image, 0, 0, w, h);
        ctx.filter = 'none';

        // Logic
        if (results.multiHandLandmarks) {
            for (const landmarks of results.multiHandLandmarks) {
                // Index Finger Tip
                const index = landmarks[8];
                const ix = index.x * w;
                const iy = index.y * h;

                // Draw Hand
                ctx.beginPath();
                ctx.arc(ix, iy, 15, 0, Math.PI*2);
                ctx.fillStyle = "white";
                ctx.fill();

                // Check Drums
                drums.forEach(drum => {
                    let dx = drum.x * w;
                    let dy = drum.y * h;
                    let dr = drum.r * h;
                    let dist = Math.sqrt((ix - dx)**2 + (iy - dy)**2);

                    if (dist < dr) {
                        if (drum.cd === 0) {
                            playSound(drum.freq, drum.type);
                            drum.cd = 10; // Cooldown
                            
                            // Visual Flash
                            ctx.shadowBlur = 40;
                            ctx.shadowColor = "white";
                            ctx.fillStyle = "white";
                            ctx.beginPath();
                            ctx.arc(dx, dy, dr, 0, Math.PI*2);
                            ctx.fill();
                            ctx.shadowBlur = 0;
                        }
                    }
                    if (drum.cd > 0) drum.cd--;
                });
            }
        }

        // Draw Static Drums
        drums.forEach(drum => {
            let dx = drum.x * w;
            let dy = drum.y * h;
            let dr = drum.r * h;
            
            ctx.strokeStyle = drum.color;
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.arc(dx, dy, dr, 0, Math.PI*2);
            ctx.stroke();
            
            ctx.fillStyle = "white";
            ctx.font = "20px Arial";
            ctx.fillText(drum.name, dx - 20, dy);
        });

        ctx.restore();
    }

    // --- INITIALIZATION ---
    initBtn.addEventListener('click', async () => {
        initBtn.style.display = 'none';
        statusLog.innerText = "Accessing Camera & Loading AI...";
        
        // 1. Wake up Audio
        initAudio();

        // 2. Start Camera & AI
        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({
            maxNumHands: 2,
            modelComplexity: 1,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });
        hands.onResults(onResults);

        const camera = new Camera(video, {
            onFrame: async () => { await hands.send({image: video}); },
            width: 1280, height: 720
        });

        try {
            await camera.start();
            statusLog.innerText = "Camera Started! Processing...";
        } catch (e) {
            statusLog.innerText = "ERROR: Camera access denied or not found.";
            statusLog.style.color = "red";
            console.error(e);
        }
    });

    // Resize Handling
    function resize() {
        canvas.width = canvas.parentElement.clientWidth;
        canvas.height = canvas.parentElement.clientHeight;
    }
    window.addEventListener('resize', resize);
    resize();

</script>
</body>
</html>
